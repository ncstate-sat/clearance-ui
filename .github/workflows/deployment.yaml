name: Update Image

on:
  push:
    branches:
      - main
      - develop
      - dev-241/automate-tests
  workflow_dispatch:

env:
  REGISTRY_URL: satregistry.ehps.ncsu.edu
  PROJECT_NAME: clearance-tool
  REPO_NAME: clearance-ui
  SLACK_UPDATES: true
  SLACK_CHANNEL_ID: C053DS40S22
  IMAGE_TAG_NAME: "{{branch}}.{{sha}}.{{date 'YYYY-MM-DD.HHmm'}}Z"
  E2E_REFRESH_TOKEN: ${{ secrets.E2E_REFRESH_TOKEN_ADMIN }}
  E2E_LIAISON_REFRESH_TOKEN: ${{ secrets.E2E_REFRESH_TOKEN_LIAISON }}
  VITE_AUTH_SERVICE_URL: 'https://auth.services.test.ehps.ncsu.edu'
  VITE_CLEARANCE_SERVICE_URL: 'https://clearance.services.test.ehps.ncsu.edu'

jobs:
  update-image:
    name: Update Image
    runs-on: sat-hosted
    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Get SAT Actions
        uses: actions/checkout@v3
        with:
          repository: SAT/sat-actions
          path: sat-actions

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Install Dependencies
        run: npm ci

      - name: Run Tests
        id: test
        run: |
          npx playwright install
          npm run e2e

      - name: Send Failure Message on Slack if Tests Fail
        if: ${{ failure() }}
        uses: ./sat-actions/slack-updates
        with:
          channel-id: ${{ github.event.inputs.slack-channel-id || env.SLACK_CHANNEL_ID }}
          message: 'The tests for `clearance-ui` have failed.'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_UPDATES: ${{ github.event.inputs.slack-updates || env.SLACK_UPDATES }}

      - name: End the Job if the Tests Fail
        if: ${{ failure() }}
        run: exit 1

      - name: Docker Login
        uses: ./sat-actions/docker-login
        with:
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
          registry-url: ${{ env.REGISTRY_URL }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: |
            ${{ env.REGISTRY_URL }}/${{env.PROJECT_NAME }}/${{ env.REPO_NAME }}
          tags: |
            type=raw,value=${{ env.IMAGE_TAG_NAME }},priority=1001
            type=ref,event=branch
            type=semver,pattern={{raw}}
            type=sha
            type=raw,value=v2

      - name: Update Docker Image
        id: image-update
        uses: ./sat-actions/update-image
        with:
          image-tag: ${{ steps.meta.outputs.tags }}
          dockerfile: ./Dockerfile

      - name: Send Failure Message on Slack if Image Upload Fails
        if: ${{ failure() && steps.image-update.conclusion == 'failure' }}
        uses: ./sat-actions/slack-updates
        with:
          channel-id: ${{ github.event.inputs.slack-channel-id || env.SLACK_CHANNEL_ID }}
          message: 'The tests for `clearance-ui` have passed, but the image failed to upload to Harbor.'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_UPDATES: ${{ github.event.inputs.slack-updates || env.SLACK_UPDATES }}

      - name: End the Job if the Image Upload Fail
        if: ${{ failure() && steps.image-update.conclusion == 'failure' }}
        run: exit 1

      - name: Send Success Message on Slack
        uses: ./sat-actions/slack-updates
        with:
          channel-id: ${{ github.event.inputs.slack-channel-id || env.SLACK_CHANNEL_ID }}
          message: 'A new image for `clearance-ui` has been uploaded to Harbor. The tag name for the image is `${{ env.IMAGE_TAG_NAME }}`'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_UPDATES: ${{ github.event.inputs.slack-updates || env.SLACK_UPDATES }}
